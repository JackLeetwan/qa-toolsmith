---
description: Backend API, database, and Supabase guidelines.
globs: ["src/pages/api/**", "src/lib/services/**", "supabase/migrations/**", "src/db/**"]
alwaysApply: false
---

# Backend & API Standards

## Supabase Integration Rules

**KRYTYCZNE:**
- **ZAWSZE** uÅ¼ywaj `context.locals.supabase` w Astro routes
- **NIGDY** nie importuj klienta Supabase bezpoÅ›rednio w API endpoints lub Astro pages
- UÅ¼ywaj typÃ³w z `src/db/database.types.ts`, nie z `@supabase/supabase-js`
- Row Level Security (RLS) jest wymagane dla wszystkich tabel
- Wszystkie operacje na bazie danych powinny respektowaÄ‡ polityki RLS

## Server-Side Access Pattern

```typescript
// âœ… DO: W API endpoint
export const POST: APIRoute = async ({ request, cookies }) => {
  const supabase = createSupabaseServerInstance({
    cookies,
    headers: request.headers,
  });
  // ...
};

// âŒ NIE RÃ“B: Import bezpoÅ›redni
import { supabaseClient } from '../../db/supabase.client.ts';
```

## API Endpoints Conventions

- **HTTP Methods:** UÅ¼ywaj `POST`, `GET` w wielkich literach
- **Prerender:** `export const prerender = false` dla wszystkich API routes
- **Walidacja:** UÅ¼ywaj schematÃ³w **Zod** do walidacji wszystkich danych wejÅ›ciowych
- **Error Responses:** Zwracaj strukturyzowane bÅ‚Ä™dy: `{ error: { code, message, details } }`
- **Response Format:** UÅ¼ywaj `snake_case` w odpowiedziach API dla zgodnoÅ›ci z backendem
- **Environment:** UÅ¼ywaj `import.meta.env` zamiast `process.env` (kompatybilne z Cloudflare Workers)

## Cookie Management

**VERY IMPORTANT:**
- UÅ¼ywaj `@supabase/ssr` package (NIE auth-helpers)
- UÅ¼ywaj TYLKO `getAll()` i `setAll()` dla zarzÄ…dzania cookies
- **NIGDY** nie uÅ¼ywaj pojedynczych metod `get`, `set`, lub `remove`
- Proper cookie options: `httpOnly: true`, `secure: true`, `sameSite: 'lax'`

## Authentication Flow

### Core Requirements

1. Use `@supabase/ssr` package (NOT auth-helpers)
2. Use ONLY `getAll` and `setAll` for cookie management
3. NEVER use individual `get`, `set`, or `remove` cookie methods
4. Implement proper session management with middleware based on JWT (Supabase Auth)
5. Always get user session first before any other operations

### Middleware Implementation

```typescript
export const onRequest = defineMiddleware(async ({ locals, cookies, url, request, redirect }, next) => {
  // Skip auth check for public paths
  if (PUBLIC_PATHS.includes(url.pathname)) {
    return next();
  }

  const supabase = createSupabaseServerInstance({
    cookies,
    headers: request.headers,
  });

  // IMPORTANT: Always get user session first
  const { data: { user } } = await supabase.auth.getUser();

  if (user) {
    locals.user = { email: user.email, id: user.id };
  } else if (!PUBLIC_PATHS.includes(url.pathname)) {
    return redirect('/auth/login');
  }

  return next();
});
```

### Common Pitfalls

1. âŒ NIE uÅ¼ywaj pojedynczych metod cookie (get/set/remove)
2. âŒ NIE importuj z @supabase/auth-helpers-nextjs
3. âŒ NIE pomijaj auth.getUser() w middleware
4. âŒ NIE modyfikuj logiki cookie handling
5. âœ… Zawsze obsÅ‚uguj zmiany stanu autentykacji prawidÅ‚owo

## Database Migrations

### Creating Migrations

**File naming convention:** `YYYYMMDDHHmmss_short_description.sql` (UTC time)

Example: `20240906123045_create_profiles.sql`

### SQL Guidelines

- Pisuj SQL w **lowercase**
- Dodaj header comment z metadata o migracji
- Dodaj szczegÃ³Å‚owe komentarze dla kaÅ¼dego kroku
- Dodaj obfite komentarze dla destructive SQL (truncate, drop, alter column)
- **ZAWSZE** wÅ‚Ä…cz Row Level Security (RLS) przy tworzeniu nowej tabeli

### RLS Policies

- Zapewnij, Å¼e polityki pokrywajÄ… wszystkie relevant access scenarios (select, insert, update, delete)
- JeÅ¼eli tabela jest public, polityka moÅ¼e zwrÃ³ciÄ‡ `true`
- Polityki powinny byÄ‡ granularne: jedna dla `select`, jedna dla `insert` itd.
- Dla kaÅ¼dej supabase role (`anon` i `authenticated`) osobna polityka
- **NIE ÅÄ„CZ** polityk, nawet jeÅ›li functionality jest taka sama dla obu rÃ³l
- Dodaj komentarze wyjaÅ›niajÄ…ce racjÄ™ i expected behavior kaÅ¼dej polityki

## Security Best Practices

- Ustaw proper cookie options (httpOnly, secure, sameSite)
- Nie eksponuj Supabase integration & keys w client-side components
- Waliduj wszystkie user input server-side
- UÅ¼ywaj proper error handling i logging
- Zasada najmniejszych uprawnieÅ„ - grant only necessary permissions

## Environment Variables

### Environment Variables

**ğŸ“š Complete environment variable documentation:** See `docs/deployment-cloudflare.md` for detailed environment variable configuration.

**Key Rules:**
- **Always use** `astro:env/server` for server-side variables, `astro:env/client` for public client-side variables
- **Never use** `import.meta.env` directly (deprecated in Astro 5)
- **Never expose** secrets client-side
- **Update** `astro.config.mjs` schema when adding new variables
